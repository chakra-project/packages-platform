# 3362 Staale Smedseng	2010-02-26
#      Bug #45058 init_available_charsets uses double checked locking
#      
#      A client doing multiple mysql_library_init() and
#      mysql_library_end() calls over the lifetime of the process may
#      experience lost character set data, potentially even a
#      SIGSEGV.
#      
#      This patch reinstates the reloading of character set data when
#      a mysql_library_init() is done after a mysql_library_end().
#
=== modified file 'include/my_sys.h'
--- a/include/my_sys.h	2009-12-12 18:11:25 +0000
+++ b/include/my_sys.h	2010-02-26 14:30:14 +0000
@@ -950,7 +950,7 @@ extern my_bool resolve_charset(const cha
 extern my_bool resolve_collation(const char *cl_name,
                                  CHARSET_INFO *default_cl,
                                  CHARSET_INFO **cl);
-
+extern void free_charsets(void);
 extern char *get_charsets_dir(char *buf);
 extern my_bool my_charset_same(CHARSET_INFO *cs1, CHARSET_INFO *cs2);
 extern my_bool init_compiled_charsets(myf flags);

=== modified file 'libmysql/libmysql.c'
--- a/libmysql/libmysql.c	2009-12-18 18:44:24 +0000
+++ b/libmysql/libmysql.c	2010-02-26 14:30:14 +0000
@@ -211,6 +211,7 @@ void STDCALL mysql_server_end()
   }
   else
   {
+    free_charsets();
     mysql_thread_end();
   }
 

=== modified file 'mysys/charset.c'
--- a/mysys/charset.c	2009-12-15 09:48:29 +0000
+++ b/mysys/charset.c	2010-02-26 14:30:14 +0000
@@ -427,6 +427,11 @@ static void init_available_charsets(void
 }
 
 
+void free_charsets(void)
+{
+  charsets_initialized= MY_PTHREAD_ONCE_INIT;
+}
+
 uint get_collation_number(const char *name)
 {
   my_pthread_once(&charsets_initialized, init_available_charsets);

=== modified file 'mysys/my_init.c'
--- a/mysys/my_init.c	2009-12-12 18:11:25 +0000
+++ b/mysys/my_init.c	2010-02-26 14:30:14 +0000
@@ -165,6 +165,7 @@ void my_end(int infoflag)
       my_print_open_files();
     }
   }
+  free_charsets();
   my_error_unregister_all();
   my_once_free();
 

=== modified file 'sql/mysqld.cc'
--- a/sql/mysqld.cc	2010-02-05 12:55:20 +0000
+++ b/sql/mysqld.cc	2010-02-26 14:30:14 +0000
@@ -1287,6 +1287,7 @@ void clean_up(bool print_message)
   lex_free();				/* Free some memory */
   item_create_cleanup();
   set_var_free();
+  free_charsets();
   if (!opt_noacl)
   {
 #ifdef HAVE_DLOPEN


--===============5369465324480993893==
MIME-Version: 1.0
Content-Type: text/bzr-bundle; charset="us-ascii";
	name="bzr/staale.smedseng@stripped"
Content-Transfer-Encoding: 7bit
Content-Disposition: inline

# Bazaar merge directive format 2 (Bazaar 0.90)
# revision_id: staale.smedseng@stripped
# target_branch: file:///export/home/tmp/ss156133/z/45058-akonadi-51/
# testament_sha1: 3cda143e1bb6fc7c9cb3c50ddf3b76b575c7208f
# timestamp: 2010-02-26 15:30:18 +0100
# base_revision_id: sergey.glukhov@stripped\
#   5pnihv36uax9kyzv
# 
# Begin bundle
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
R2H/xdyRThQkDCT28wA=


--===============5369465324480993893==--
